<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç®€å•å­¦æ‹¼éŸ³</title>
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --gold-color: #FFD700;
            --text-color: #2d3436;
            --success-color: #42e695;
            --danger-color: #ff7675;
            --line-outer: #a29bfe; /* å¤–çº¿é¢œè‰² */
            --line-inner: #ff7675; /* å†…çº¿é¢œè‰² */
            --seq-gradient: linear-gradient(90deg, #42e695 0%, #3bb2b8 100%);
            --random-gradient: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            min-height: 100vh; min-height: -webkit-fill-available;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; color: var(--text-color); overflow-x: hidden;
        }

        .bg-shape { position: absolute; border-radius: 50%; filter: blur(80px); z-index: -1; animation: float 20s infinite; }
        .shape-1 { width: 300px; height: 300px; background: #ff9a9e; top: -50px; left: -100px; }
        .shape-2 { width: 400px; height: 400px; background: #a18cd1; bottom: -100px; right: -100px; animation-delay: -5s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, -30px); } }

        .container {
            width: 100%; max-width: 600px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            padding: 25px 30px; position: relative;
            padding-bottom: max(60px, env(safe-area-inset-bottom));
        }

        .header { text-align: center; margin-bottom: 20px; }
        .title {
            font-family: 'Zcool KuaiLe', cursive; font-size: clamp(24px, 5vw, 36px);
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px;
        }

        .mode-switch-container {
            display: flex; background: rgba(255,255,255,0.5); padding: 4px;
            border-radius: 30px; width: fit-content; margin: 0 auto;
        }
        .mode-btn {
            padding: 8px 16px; border: none; border-radius: 25px; background: transparent;
            font-size: 14px; font-weight: bold; color: #666; cursor: pointer;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;
        }
        .mode-btn.active { background: #fff; color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .mode-btn.active[data-mode="sequential"] { color: #2ecc71; }

        .main-display {
            min-height: 220px; /* å¢åŠ é«˜åº¦ä»¥å®¹çº³å››çº¿ä¸‰æ ¼ */
            display: flex; align-items: center; justify-content: center; margin-bottom: 25px;
        }

        /* ----- æ ¸å¿ƒä¿®æ”¹ï¼šæ‹¼éŸ³å¡ç‰‡ä¸å››çº¿ä¸‰æ ¼ ----- */
        .pinyin-card {
            width: min(280px, 65vw);
            aspect-ratio: 1 / 1.1; /* ä¿æŒæ¯”ä¾‹ */
            background: #fff; border-radius: 30px;
            display: flex; flex-direction: column; 
            align-items: center; 
            /* justify-content: center;  ä¸å†å‚ç›´å±…ä¸­ï¼Œæ”¹ä¸ºé ä¸Šå¸ƒå±€ */
            cursor: pointer; position: relative; border: 4px solid #fff;
            box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1);
            transition: all 0.2s; 
            padding-top: 40px; /* ç»™é¡¶éƒ¨ç•™ç©ºé—´ */
            z-index: 5;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        .pinyin-card:active { transform: scale(0.98); }
        .pinyin-card.mastered { border-color: var(--gold-color); box-shadow: 0 0 25px rgba(255, 215, 0, 0.3); }

        /* å››çº¿ä¸‰æ ¼å®¹å™¨ */
        .grid-container {
            position: relative;
            width: 80%;
            height: 120px; /* æ€»é«˜åº¦ï¼Œåˆ†ä¸º3ä¸ª40pxçš„æ ¼ */
            margin-bottom: 20px;
        }

        /* ç»˜åˆ¶çº¿æ¡ */
        .grid-lines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            box-sizing: border-box;
            border-top: 2px solid var(--line-outer);    /* ç¬¬ä¸€çº¿ */
            border-bottom: 2px solid var(--line-outer); /* ç¬¬å››çº¿ */
            /* ä½¿ç”¨æ¸å˜ç»˜åˆ¶ä¸­é—´ä¸¤æ¡è™šçº¿/ç»†çº¿ */
            background: linear-gradient(
                to bottom,
                transparent 39px, 
                var(--line-inner) 40px, /* ç¬¬äºŒçº¿ */
                transparent 41px, 
                transparent 79px, 
                var(--line-inner) 80px, /* ç¬¬ä¸‰çº¿ */
                transparent 81px
            );
        }
        
        /* æ‹¼éŸ³æ–‡å­— - ç²¾ç¡®å¯¹é½ */
        .pinyin-text {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            font-family: 'Nunito', sans-serif; /* Nunito å­—ä½“æ¯”è¾ƒåœ†æ¶¦ï¼Œé€‚åˆæ‹¼éŸ³ */
            font-size: 80px; /* å­—ä½“å¤§å°çº¦ä¸ºæ ¼å­é«˜åº¦çš„2å€ï¼Œè¦†ç›–ä¸Šä¸­ä¸‹ */
            font-weight: 700;
            color: #333;
            line-height: 120px; /* è¡Œé«˜ = å®¹å™¨é«˜åº¦ï¼Œè®©åŸºçº¿å¤§è‡´å¯¹é½ç¬¬ä¸‰çº¿ */
            text-align: center;
            z-index: 2;
            
            /* å¾®è°ƒä½ç½®ï¼šNunitoå­—ä½“çš„åŸºçº¿éœ€è¦ç¨å¾®å¾€ä¸Šæä¸€ç‚¹ç‚¹æ‰èƒ½å®Œç¾å‹åœ¨ç¬¬ä¸‰çº¿ä¸Š */
            transform: translateY(-8px); 
        }

        /* ç¤ºä¾‹å­—å®¹å™¨ - ç§»åˆ°åº•éƒ¨ */
        .examples-container {
            display: flex; width: 100%; justify-content: space-around;
            padding-top: 15px; 
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
            margin-bottom: 20px;
            border-top: 2px dashed #f0f2f5;
        }
        .example-item { display: flex; flex-direction: column; align-items: center; color: #444; }
        .example-char { font-size: clamp(20px, 5vw, 24px); font-weight: bold; line-height: 1.2; }
        .example-pinyin { font-size: 12px; color: #888; font-weight: 600; }

        .queue-badge {
            position: absolute; top: 12px; left: 12px;
            background: rgba(0,0,0,0.05); color: #888;
            font-size: 11px; padding: 3px 8px; border-radius: 10px; font-weight: bold;
        }

        .control-panel { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; position: relative; z-index: 10; }
        .category-tabs {
            display: flex; justify-content: center; gap: 6px;
            background: rgba(255,255,255,0.5); padding: 6px; border-radius: 18px;
        }
        .tab {
            padding: 8px 12px; border: none; border-radius: 12px; background: transparent;
            color: #666; font-size: 13px; font-weight: 600; cursor: pointer; flex: 1;
        }
        .tab.active { background: #fff; color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .action-bar { display: flex; gap: 15px; justify-content: center; width: 100%; max-width: 350px; margin: 0 auto; }
        
        .mastery-toggle-btn {
            flex: 0 0 70px; height: 60px; border-radius: 20px; border: 2px solid #fff;
            background: #f0f2f5; color: #ccc; font-size: 28px; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .mastery-toggle-btn.active {
            background: #fff9db; color: var(--gold-color); border-color: var(--gold-color);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
        }

        .next-btn {
            flex: 1; height: 60px; border: none; border-radius: 20px;
            background: var(--random-gradient);
            color: white; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3); display: flex;
            align-items: center; justify-content: center; gap: 10px;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .next-btn:active { transform: translateY(3px); }
        .next-btn.sequential-mode { background: var(--seq-gradient); box-shadow: 0 8px 20px rgba(66, 230, 149, 0.3); }

        .stats-panel {
            background: rgba(255,255,255,0.6); border-radius: 20px; padding: 15px 20px;
            display: flex; flex-direction: column; gap: 8px; position: relative; z-index: 10;
        }
        .stats-header { display: flex; justify-content: space-between; font-size: 13px; color: #666; font-weight: bold; }
        .progress-container { height: 8px; background: #fff; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease; background: var(--random-gradient); }
        .progress-fill.sequential { background: var(--seq-gradient); }

        .reset-btn-container { display: flex; justify-content: center; margin-top: 10px; }
        .reset-link { 
            text-align: center; font-size: 13px; font-weight: bold; color: #fff;
            background: var(--danger-color); border: none; cursor: pointer; padding: 10px 25px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(255, 118, 117, 0.3); transition: all 0.2s; position: relative; z-index: 100;
        }
        .reset-link:active { transform: scale(0.95); filter: brightness(0.9); }
        
        .toast {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0,0,0,0.85); color: white; padding: 15px 30px;
            border-radius: 30px; z-index: 2000; opacity: 0; pointer-events: none;
            transition: all 0.3s; text-align: center; font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center;
            z-index: 3000; opacity: 0; transition: opacity 0.2s;
        }
        .confirm-modal.show { opacity: 1; }
        .confirm-content {
            background: #fff; padding: 25px; border-radius: 25px;
            width: 80%; max-width: 300px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.2s;
        }
        .confirm-modal.show .confirm-content { transform: scale(1); }
        .confirm-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .confirm-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
        .confirm-btns { display: flex; gap: 10px; }
        .c-btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .c-btn-cancel { background: #f1f2f6; color: #666; }
        .c-btn-confirm { background: var(--danger-color); color: white; }
        
        .star-anim { position: absolute; color: #FFD700; font-size: 24px; animation: starPop 0.8s ease-out forwards; pointer-events: none; z-index: 10; }
        @keyframes starPop {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="toast" id="toast">æç¤ºä¿¡æ¯</div>

    <div class="container">
        <div class="header">
            <h1 class="title">âœ¨ å¿«ä¹å­¦æ‹¼éŸ³ âœ¨</h1>
            <div class="mode-switch-container">
                <button class="mode-btn active" data-mode="random">ğŸ² æ£€éªŒæ¨¡å¼</button>
                <button class="mode-btn" data-mode="sequential">ğŸ“š å­¦ä¹ æ¨¡å¼</button>
            </div>
        </div>

        <div class="main-display">
            <div class="pinyin-card" id="pinyinCard">
                <div class="queue-badge" id="queueBadge">å‰© 23 ä¸ª</div>
                
                <!-- å››çº¿ä¸‰æ ¼ç»“æ„ -->
                <div class="grid-container">
                    <div class="grid-lines"></div>
                    <div class="pinyin-text" id="pinyinText">b</div>
                </div>
                
                <div class="examples-container" id="examplesContainer"></div>
            </div>
        </div>

        <div class="control-panel">
            <div class="category-tabs">
                <button class="tab active" data-category="all">å…¨éƒ¨</button>
                <button class="tab" data-category="initials">å£°æ¯</button>
                <button class="tab" data-category="finals">éŸµæ¯</button>
                <button class="tab" data-category="whole">æ•´ä½“</button>
            </div>

            <div class="action-bar">
                <button class="mastery-toggle-btn" id="masteryBtn" title="æ ‡è®°ä¸ºå·²æŒæ¡">â˜…</button>
                <button class="next-btn" id="nextBtn">
                    <span id="nextBtnText">éšæœºæ¢</span>
                    <span>ğŸ‘‰</span>
                </button>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stats-header">
                <span id="statsLabel">ğŸ† å…¨å±€æŒæ¡è¿›åº¦</span>
                <span id="statsPercentage">0%</span>
            </div>
            <div class="progress-container">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center; margin-top: 4px; font-size: 12px; color: #999;" id="statsText">
                å·²æŒæ¡ 0 / 0 ä¸ª
            </div>
            <div class="reset-btn-container">
                <button class="reset-link" id="resetBtn">ğŸ—‘ï¸ æ¸…ç©ºæŒæ¡è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-title" id="confirmTitle">ç¡®è®¤æ“ä½œ</div>
            <div class="confirm-desc" id="confirmDesc">å†…å®¹æè¿°</div>
            <div class="confirm-btns">
                <button class="c-btn c-btn-cancel" id="confirmCancel">å–æ¶ˆ</button>
                <button class="c-btn c-btn-confirm" id="confirmOk">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <script>
        const initials = ['b','p','m','f','d','t','n','l','g','k','h','j','q','x','zh','ch','sh','r','z','c','s','y','w'];
        const finals = ['a','o','e','i','u','Ã¼','ai','ei','ui','ao','ou','iu','ie','Ã¼e','er','an','en','in','un','Ã¼n','ang','eng','ing','ong'];
        const wholeSyllables = ['zhi','chi','shi','ri','zi','ci','si','yi','wu','yu','ye','yue','yuan','yin','yun','ying'];

        const pinyinToChars = {
            'b': ['çˆ¸(bÃ )', 'æ³¢(bÅ)', 'ä¸(bÃ¹)'], 'p': ['å¡(pÅ)', 'æ€•(pÃ )', 'æ‹(pÄi)'],
            'm': ['å¦ˆ(mÄ)', 'æ‘¸(mÅ)', 'ç±³(mÇ)'], 'f': ['å‘(fÄ)', 'ä½›(fÃ³)', 'é£(fÄ“i)'],
            'd': ['å¤§(dÃ )', 'çš„(de)', 'åœ°(dÃ¬)'], 't': ['ä»–(tÄ)', 'å¤©(tiÄn)', 'åœŸ(tÇ”)'],
            'n': ['é‚£(nÃ )', 'ä½ (nÇ)', 'å¥³(nÇš)'], 'l': ['æ‹‰(lÄ)', 'äº†(le)', 'é‡Œ(lÇ)'],
            'g': ['å“¥(gÄ“)', 'ä¸ª(gÃ¨)', 'ç‹—(gÇ’u)'], 'k': ['å¯(kÄ›)', 'å£(kÇ’u)', 'å¼€(kÄi)'],
            'h': ['å¥½(hÇo)', 'å’Œ(hÃ©)', 'èŠ±(huÄ)'], 'j': ['å®¶(jiÄ)', 'å«(jiÃ o)', 'ä¹(jiÇ”)'],
            'q': ['ä¸ƒ(qÄ«)', 'å»(qÃ¹)', 'å‰(qiÃ¡n)'], 'x': ['ä¸‹(xiÃ )', 'å°(xiÇo)', 'å¿ƒ(xÄ«n)'],
            'zh': ['ä¸­(zhÅng)', 'åª(zhÇ)', 'ç€(zhe)'], 'ch': ['å‡º(chÅ«)', 'åƒ(chÄ«)', 'è½¦(chÄ“)'],
            'sh': ['ä¸Š(shÃ ng)', 'æ˜¯(shÃ¬)', 'æ‰‹(shÇ’u)'], 'r': ['äºº(rÃ©n)', 'çƒ­(rÃ¨)', 'æ—¥(rÃ¬)'],
            'z': ['åœ¨(zÃ i)', 'å­(zÇ)', 'èµ°(zÇ’u)'], 'c': ['ä»(cÃ³ng)', 'æ¬¡(cÃ¬)', 'è‰(cÇo)'],
            's': ['ä¸‰(sÄn)', 'å››(sÃ¬)', 'é€(sÃ²ng)'], 'y': ['ä¸€(yÄ«)', 'æœ‰(yÇ’u)', 'æœˆ(yuÃ¨)'],
            'w': ['æˆ‘(wÇ’)', 'äº”(wÇ”)', 'å¤–(wÃ i)'], 'a': ['å•Š(a)', 'é˜¿(Ä)', 'è…Œ(Ä)'],
            'o': ['å“¦(o)', 'å™¢(Å)', 'æ³¢(bÅ)'], 'e': ['é¹…(Ã©)', 'é¥¿(Ã¨)', 'é¢(Ã©)'],
            'i': ['è¡£(yÄ«)', 'ä»¥(yÇ)', 'ä¸€(yÄ«)'], 'u': ['ä¹Œ(wÅ«)', 'å±‹(wÅ«)', 'äº”(wÇ”)'],
            'Ã¼': ['é±¼(yÃº)', 'é›¨(yÇ”)', 'ç‰(yÃ¹)'], 'ai': ['çˆ±(Ã i)', 'ç™½(bÃ¡i)', 'å¤ª(tÃ i)'],
            'ei': ['é»‘(hÄ“i)', 'ç»™(gÄ›i)', 'é(fÄ“i)'], 'ui': ['ä¼š(huÃ¬)', 'æ°´(shuÇ)', 'å›(huÃ­)'],
            'ao': ['å¥½(hÇo)', 'é«˜(gÄo)', 'æ—©(zÇo)'], 'ou': ['å(hÃ²u)', 'æ‰‹(shÇ’u)', 'å£(kÇ’u)'],
            'iu': ['æœ‰(yÇ’u)', 'å…­(liÃ¹)', 'ç‰›(niÃº)'], 'ie': ['ä¹Ÿ(yÄ›)', 'å§(jiÄ›)', 'èŠ‚(jiÃ©)'],
            'Ã¼e': ['æœˆ(yuÃ¨)', 'å­¦(xuÃ©)', 'é›ª(xuÄ›)'], 'er': ['å„¿(Ã©r)', 'äºŒ(Ã¨r)', 'è€³(Ä›r)'],
            'an': ['å¤©(tiÄn)', 'åŠ(bÃ n)', 'çœ‹(kÃ n)'], 'en': ['å¾ˆ(hÄ›n)', 'é—¨(mÃ©n)', 'äºº(rÃ©n)'],
            'in': ['å¿ƒ(xÄ«n)', 'éŸ³(yÄ«n)', 'ä»Š(jÄ«n)'], 'un': ['æ˜¥(chÅ«n)', 'æ‘(cÅ«n)', 'å­™(sÅ«n)'],
            'Ã¼n': ['äº‘(yÃºn)', 'è¿(yÃ¹n)', 'è£™(qÃºn)'], 'ang': ['å¸®(bÄng)', 'å…‰(guÄng)', 'æ–¹(fÄng)'],
            'eng': ['ç¯(dÄ“ng)', 'é£(fÄ“ng)', 'å†·(lÄ›ng)'], 'ing': ['å¬(tÄ«ng)', 'æ˜(mÃ­ng)', 'æ˜Ÿ(xÄ«ng)'],
            'ong': ['ä¸­(zhÅng)', 'é¾™(lÃ³ng)', 'çº¢(hÃ³ng)'], 
            'zhi': ['åª(zhÇ)', 'çŸ¥(zhÄ«)', 'ç›´(zhÃ­)'], 'chi': ['åƒ(chÄ«)', 'è¿Ÿ(chÃ­)', 'å°º(chÇ)'], 
            'shi': ['æ˜¯(shÃ¬)', 'å(shÃ­)', 'ç‹®(shÄ«)'], 'ri': ['æ—¥(rÃ¬)', 'ç”Ÿæ—¥(rÃ¬)', 'æ—¥å†(rÃ¬)'], 
            'zi': ['å­(zÇ)', 'å­—(zÃ¬)', 'ç´«(zÇ)'], 'ci': ['æ¬¡(cÃ¬)', 'è¯(cÃ­)', 'ç“·(cÃ­)'], 
            'si': ['å››(sÃ¬)', 'ä¸(sÄ«)', 'ä¼¼(sÃ¬)'], 'yi': ['ä¸€(yÄ«)', 'è¡£(yÄ«)', 'åŒ»(yÄ«)'], 
            'wu': ['æ— (wÃº)', 'äº”(wÇ”)', 'å±‹(wÅ«)'], 'yu': ['é±¼(yÃº)', 'ç‰(yÃ¹)', 'é›¨(yÇ”)'], 
            'ye': ['ä¹Ÿ(yÄ›)', 'å¤œ(yÃ¨)', 'å¶(yÃ¨)'], 'yue': ['æœˆ(yuÃ¨)', 'è¶Š(yuÃ¨)', 'ä¹(yuÃ¨)'], 
            'yuan': ['åœ†(yuÃ¡n)', 'å…ƒ(yuÃ¡n)', 'è¿œ(yuÇn)'], 'yin': ['éŸ³(yÄ«n)', 'é˜´(yÄ«n)', 'é“¶(yÃ­n)'], 
            'yun': ['äº‘(yÃºn)', 'æ™•(yÅ«n)', 'åŒ€(yÃºn)'], 'ying': ['å½±(yÇng)', 'ç¡¬(yÃ¬ng)', 'é¹°(yÄ«ng)']
        };

        class PinyinApp {
            constructor() {
                this.currentCategory = 'all';
                this.currentPinyin = '';
                this.playQueue = []; 
                this.currentListTotal = 0;
                
                this.masteredSet = this.loadData('pinyin_mastered_v1', new Set());
                this.seqProgress = this.loadData('pinyin_seq_progress', {}); 

                this.totalPinyinCount = initials.length + finals.length + wholeSyllables.length;
                this.mode = 'random'; 
                
                this.initElements();
                this.bindEvents();
                
                this.switchMode('random');
                this.switchCategory('all', false);
            }

            initElements() {
                this.pinyinCard = document.getElementById('pinyinCard');
                this.pinyinText = document.getElementById('pinyinText');
                this.examplesContainer = document.getElementById('examplesContainer');
                this.masteryBtn = document.getElementById('masteryBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.nextBtnText = document.getElementById('nextBtnText');
                this.resetBtn = document.getElementById('resetBtn');
                this.statsLabel = document.getElementById('statsLabel');
                this.statsText = document.getElementById('statsText');
                this.statsPercentage = document.getElementById('statsPercentage');
                this.progressFill = document.getElementById('progressFill');
                this.tabs = document.querySelectorAll('.tab');
                this.queueBadge = document.getElementById('queueBadge');
                this.toast = document.getElementById('toast');
                this.modeBtns = document.querySelectorAll('.mode-btn');
                
                this.confirmModal = document.getElementById('confirmModal');
                this.confirmTitle = document.getElementById('confirmTitle');
                this.confirmDesc = document.getElementById('confirmDesc');
                this.confirmCancel = document.getElementById('confirmCancel');
                this.confirmOk = document.getElementById('confirmOk');
            }

            bindEvents() {
                this.pinyinCard.addEventListener('click', () => this.nextPinyin());
                this.nextBtn.addEventListener('click', (e) => {
                    e.currentTarget.blur();
                    this.nextPinyin();
                });
                this.masteryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleMastery();
                });
                
                this.resetBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showConfirm();
                });

                this.confirmCancel.addEventListener('click', () => this.hideConfirm());
                this.confirmOk.addEventListener('click', () => {
                    this.performReset();
                    this.hideConfirm();
                });
                
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', () => this.switchCategory(tab.dataset.category));
                });

                this.modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.switchMode(btn.dataset.mode));
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === ' ' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        this.nextPinyin();
                    }
                });
            }

            switchMode(newMode) {
                if (this.mode === newMode && this.currentPinyin) return;
                this.mode = newMode;
                
                this.modeBtns.forEach(btn => {
                    if (btn.dataset.mode === newMode) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                
                if (newMode === 'sequential') {
                    this.nextBtn.classList.add('sequential-mode');
                    this.progressFill.classList.add('sequential');
                    this.nextBtnText.textContent = 'ä¸‹ä¸€ä¸ª';
                    this.resetBtn.textContent = 'ğŸ”„ ä»å¤´å¼€å§‹å­¦ä¹ ';
                    this.resetBtn.style.background = '#42e695';
                } else {
                    this.nextBtn.classList.remove('sequential-mode');
                    this.progressFill.classList.remove('sequential');
                    this.nextBtnText.textContent = 'éšæœºæ¢';
                    this.resetBtn.textContent = 'ğŸ—‘ï¸ æ¸…ç©ºæŒæ¡è®°å½•';
                    this.resetBtn.style.background = '#ff7675';
                }

                this.generateQueue(this.currentCategory);
                this.nextPinyin();
            }

            switchCategory(category, refresh = true) {
                if (this.currentCategory === category && this.currentPinyin) return;
                this.currentCategory = category;
                
                this.tabs.forEach(tab => {
                    if (tab.dataset.category === category) tab.classList.add('active');
                    else tab.classList.remove('active');
                });
                
                if (refresh) {
                    this.generateQueue(category);
                    this.nextPinyin();
                }
            }

            generateQueue(category) {
                let list;
                switch(category) {
                    case 'initials': list = [...initials]; break;
                    case 'finals': list = [...finals]; break;
                    case 'whole': list = [...wholeSyllables]; break;
                    default: list = [...initials, ...finals, ...wholeSyllables];
                }
                
                this.currentListTotal = list.length;

                if (this.mode === 'sequential') {
                    const savedIndex = this.seqProgress[category] || 0;
                    if (savedIndex >= list.length) {
                         this.playQueue = [];
                    } else {
                        this.playQueue = list.slice(savedIndex).reverse();
                    }
                } else {
                    for (let i = list.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [list[i], list[j]] = [list[j], list[i]];
                    }
                    this.playQueue = list;
                }
            }

            nextPinyin() {
                if (this.playQueue.length === 0) {
                    if (this.mode === 'sequential') {
                        this.showToast("ğŸ‰ æœ¬ç»„å­¦ä¹ å®Œæˆï¼<br>è‡ªåŠ¨ä»å¤´å¼€å§‹");
                        this.seqProgress[this.currentCategory] = 0;
                        this.saveSeqProgress();
                        this.generateQueue(this.currentCategory);
                    } else {
                        this.showToast("âœ¨ æœ¬è½®å¤ä¹ å®Œæˆï¼<br>é‡æ–°æ´—ç‰Œ");
                        this.generateQueue(this.currentCategory);
                    }
                }

                this.currentPinyin = this.playQueue.pop();
                
                if (this.mode === 'sequential') {
                    const currentIndex = this.currentListTotal - this.playQueue.length;
                    this.seqProgress[this.currentCategory] = currentIndex;
                    this.saveSeqProgress();
                }

                this.pinyinText.classList.remove('rotating');
                void this.pinyinText.offsetWidth; 
                this.updateDisplay();
                this.updateStats();
            }

            updateDisplay() {
                this.pinyinText.textContent = this.currentPinyin;
                
                if (this.mode === 'sequential') {
                     this.queueBadge.textContent = `å‰©ä½™ ${this.playQueue.length} ä¸ª`;
                } else {
                     this.queueBadge.textContent = `æœ¬è½®å‰© ${this.playQueue.length} ä¸ª`;
                }
                
                const chars = pinyinToChars[this.currentPinyin] || ['æ— æ•°æ®'];
                this.examplesContainer.innerHTML = chars.slice(0, 3).map(char => {
                    const match = char.match(/(.+)\((.+)\)/);
                    if (match) return `<div class="example-item"><span class="example-char">${match[1]}</span><span class="example-pinyin">${match[2]}</span></div>`;
                    return `<div class="example-item"><span class="example-char">${char}</span></div>`;
                }).join('');

                const isMastered = this.masteredSet.has(this.currentPinyin);
                if (isMastered) {
                    this.masteryBtn.classList.add('active');
                    this.pinyinCard.classList.add('mastered');
                    this.masteryBtn.textContent = 'â˜…'; 
                } else {
                    this.masteryBtn.classList.remove('active');
                    this.pinyinCard.classList.remove('mastered');
                    this.masteryBtn.textContent = 'â˜†'; 
                }
            }

            updateStats() {
                if (this.mode === 'sequential') {
                    const currentIndex = this.seqProgress[this.currentCategory] || 0;
                    const displayIndex = Math.min(currentIndex, this.currentListTotal);
                    const progress = this.currentListTotal === 0 ? 0 : (displayIndex / this.currentListTotal) * 100;
                    
                    this.statsLabel.textContent = "ğŸ“š å½“å‰åˆ†ç±»è¿›åº¦";
                    this.progressFill.style.width = `${progress}%`;
                    this.statsText.textContent = `å·²å­¦ ${displayIndex} / ${this.currentListTotal}`;
                    this.statsPercentage.textContent = Math.round(progress) + '%';
                } else {
                    const count = this.masteredSet.size;
                    const progress = (count / this.totalPinyinCount) * 100;
                    
                    this.statsLabel.textContent = "ğŸ† å…¨å±€æŒæ¡è¿›åº¦";
                    this.progressFill.style.width = `${Math.min(progress, 100)}%`;
                    this.statsText.textContent = `å…±æŒæ¡ ${count} / ${this.totalPinyinCount}`;
                    this.statsPercentage.textContent = Math.round(progress) + '%';
                }
            }

            toggleMastery() {
                if (this.masteredSet.has(this.currentPinyin)) {
                    this.masteredSet.delete(this.currentPinyin);
                } else {
                    this.masteredSet.add(this.currentPinyin);
                    this.createStars(); 
                }
                this.saveMasteredData();
                this.updateDisplay();
                if (this.mode === 'random') {
                    this.updateStats();
                }
            }

            showConfirm() {
                if (this.mode === 'sequential') {
                    this.confirmTitle.textContent = "é‡æ–°å­¦ä¹ ";
                    this.confirmDesc.textContent = "ç¡®å®šè¦ä»ç¬¬ä¸€ä¸ªæ‹¼éŸ³å¼€å§‹é‡æ–°å­¦ä¹ å½“å‰åˆ†ç±»å—ï¼Ÿ";
                } else {
                    this.confirmTitle.textContent = "æ¸…ç©ºè®°å½•";
                    this.confirmDesc.textContent = "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²æŒæ¡çš„æ˜Ÿæ˜Ÿè®°å½•å—ï¼Ÿ";
                }
                this.confirmModal.style.display = 'flex';
                setTimeout(() => this.confirmModal.classList.add('show'), 10);
            }

            hideConfirm() {
                this.confirmModal.classList.remove('show');
                setTimeout(() => this.confirmModal.style.display = 'none', 200);
            }

            performReset() {
                if (this.mode === 'sequential') {
                    this.seqProgress[this.currentCategory] = 0;
                    this.saveSeqProgress();
                    this.generateQueue(this.currentCategory);
                    this.nextPinyin();
                    this.showToast('ğŸ“š å·²é‡ç½®è¿›åº¦ï¼Œä»å¤´å¼€å§‹');
                } else {
                    this.masteredSet.clear();
                    this.saveMasteredData();
                    this.updateDisplay();
                    this.updateStats();
                    this.showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºæŒæ¡è®°å½•');
                }
            }

            showToast(msg) {
                this.toast.innerHTML = msg;
                this.toast.classList.add('show');
                setTimeout(() => {
                    this.toast.classList.remove('show');
                }, 2000);
            }

            createStars() {
                const colors = ['#FFD700', '#FF9A9E', '#A18CD1', '#84FAB0'];
                for (let i = 0; i < 8; i++) {
                    const star = document.createElement('div');
                    star.className = 'star-anim';
                    star.textContent = 'â˜…';
                    star.style.left = (20 + Math.random() * 60) + '%';
                    star.style.top = (20 + Math.random() * 60) + '%';
                    star.style.color = colors[Math.floor(Math.random() * colors.length)];
                    star.style.fontSize = (20 + Math.random() * 20) + 'px';
                    this.pinyinCard.appendChild(star);
                    setTimeout(() => star.remove(), 800);
                }
            }

            loadData(key, defaultVal) {
                try {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (defaultVal instanceof Set) return new Set(parsed);
                        return parsed;
                    }
                } catch (e) { }
                return defaultVal;
            }

            saveMasteredData() {
                localStorage.setItem('pinyin_mastered_v1', JSON.stringify(Array.from(this.masteredSet)));
            }

            saveSeqProgress() {
                localStorage.setItem('pinyin_seq_progress', JSON.stringify(this.seqProgress));
            }
        }

        const app = new PinyinApp();
    </script>
</body>
</html>

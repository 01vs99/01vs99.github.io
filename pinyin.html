<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Âø´‰πêÂ≠¶ÊãºÈü≥ - ÁªàÊûÅ‰øÆÂ§çÁâà</title>
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --gold-color: #FFD700;
            --text-color: #2d3436;
            --success-color: #42e695;
            --danger-color: #ff7675;
            --seq-gradient: linear-gradient(90deg, #42e695 0%, #3bb2b8 100%);
            --random-gradient: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            min-height: 100vh; min-height: -webkit-fill-available;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; color: var(--text-color); overflow-x: hidden;
        }

        .bg-shape { position: absolute; border-radius: 50%; filter: blur(80px); z-index: -1; animation: float 20s infinite; }
        .shape-1 { width: 300px; height: 300px; background: #ff9a9e; top: -50px; left: -100px; }
        .shape-2 { width: 400px; height: 400px; background: #a18cd1; bottom: -100px; right: -100px; animation-delay: -5s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(30px, -30px); } }

        .container {
            width: 100%; max-width: 600px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            padding: 25px 30px; position: relative;
            padding-bottom: max(60px, env(safe-area-inset-bottom));
        }

        .header { text-align: center; margin-bottom: 20px; }
        .title {
            font-family: 'Zcool KuaiLe', cursive; font-size: clamp(24px, 5vw, 36px);
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 15px;
        }

        .mode-switch-container {
            display: flex; background: rgba(255,255,255,0.5); padding: 4px;
            border-radius: 30px; width: fit-content; margin: 0 auto;
        }
        .mode-btn {
            padding: 8px 16px; border: none; border-radius: 25px; background: transparent;
            font-size: 14px; font-weight: bold; color: #666; cursor: pointer;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 5px;
        }
        .mode-btn.active { background: #fff; color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .mode-btn.active[data-mode="sequential"] { color: #2ecc71; }

        .main-display {
            min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 25px;
        }

        .pinyin-card {
            width: min(280px, 65vw); aspect-ratio: 1 / 1.1;
            background: #fff; border-radius: 40px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            cursor: pointer; position: relative; border: 4px solid #fff;
            box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1);
            transition: all 0.2s; padding: 20px 10px; z-index: 5;
        }
        .pinyin-card:active { transform: scale(0.98); }
        .pinyin-card.mastered { border-color: var(--gold-color); box-shadow: 0 0 25px rgba(255, 215, 0, 0.3); }

        .pinyin-text {
            font-size: clamp(80px, 22vw, 130px); font-weight: 800;
            background: linear-gradient(180deg, #333 30%, #666 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            line-height: 1; flex: 1; display: flex; align-items: center; justify-content: center;
        }

        .examples-container {
            display: flex; width: 100%; justify-content: space-around;
            padding-top: 10px; border-top: 2px dashed #f0f2f5;
        }
        .example-item { display: flex; flex-direction: column; align-items: center; color: #444; }
        .example-char { font-size: clamp(20px, 5vw, 26px); font-weight: bold; line-height: 1.2; }
        .example-pinyin { font-size: 12px; color: #888; font-weight: 600; }

        .queue-badge {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.05); color: #888;
            font-size: 12px; padding: 4px 10px; border-radius: 12px; font-weight: bold;
        }

        .control-panel { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; position: relative; z-index: 10; }
        .category-tabs {
            display: flex; justify-content: center; gap: 6px;
            background: rgba(255,255,255,0.5); padding: 6px; border-radius: 18px;
        }
        .tab {
            padding: 8px 12px; border: none; border-radius: 12px; background: transparent;
            color: #666; font-size: 13px; font-weight: 600; cursor: pointer; flex: 1;
        }
        .tab.active { background: #fff; color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .action-bar { display: flex; gap: 15px; justify-content: center; width: 100%; max-width: 350px; margin: 0 auto; }
        
        .mastery-toggle-btn {
            flex: 0 0 70px; height: 60px; border-radius: 20px; border: 2px solid #fff;
            background: #f0f2f5; color: #ccc; font-size: 28px; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .mastery-toggle-btn.active {
            background: #fff9db; color: var(--gold-color); border-color: var(--gold-color);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
        }

        .next-btn {
            flex: 1; height: 60px; border: none; border-radius: 20px;
            background: var(--random-gradient);
            color: white; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3); display: flex;
            align-items: center; justify-content: center; gap: 10px;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .next-btn:active { transform: translateY(3px); }
        .next-btn.sequential-mode { background: var(--seq-gradient); box-shadow: 0 8px 20px rgba(66, 230, 149, 0.3); }

        .stats-panel {
            background: rgba(255,255,255,0.6); border-radius: 20px; padding: 15px 20px;
            display: flex; flex-direction: column; gap: 8px; position: relative; z-index: 10;
        }
        .stats-header { display: flex; justify-content: space-between; font-size: 13px; color: #666; font-weight: bold; }
        .progress-container { height: 8px; background: #fff; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease; background: var(--random-gradient); }
        .progress-fill.sequential { background: var(--seq-gradient); }

        .reset-btn-container { display: flex; justify-content: center; margin-top: 10px; }
        
        /* ÂΩªÂ∫ïÈáçÊûÑÁöÑÈáçÁΩÆÊåâÈíÆ */
        .reset-link { 
            text-align: center; font-size: 13px; font-weight: bold;
            color: #fff;
            background: var(--danger-color);
            border: none;
            cursor: pointer; padding: 10px 25px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(255, 118, 117, 0.3);
            transition: all 0.2s;
            position: relative; z-index: 100; /* Á°Æ‰øùÂú®ÊúÄÈ°∂Â±Ç */
            -webkit-appearance: none; /* ÁßªÈô§iOSÈªòËÆ§Ê†∑Âºè */
        }
        .reset-link:active { transform: scale(0.95); filter: brightness(0.9); }
        
        .toast {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0,0,0,0.85); color: white; padding: 15px 30px;
            border-radius: 30px; z-index: 2000; opacity: 0; pointer-events: none;
            transition: all 0.3s; text-align: center; font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü */
        .confirm-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center;
            z-index: 3000; opacity: 0; transition: opacity 0.2s;
        }
        .confirm-modal.show { opacity: 1; }
        .confirm-content {
            background: #fff; padding: 25px; border-radius: 25px;
            width: 80%; max-width: 300px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.2s;
        }
        .confirm-modal.show .confirm-content { transform: scale(1); }
        .confirm-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .confirm-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
        .confirm-btns { display: flex; gap: 10px; }
        .c-btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .c-btn-cancel { background: #f1f2f6; color: #666; }
        .c-btn-confirm { background: var(--danger-color); color: white; }
        
        .star-anim { position: absolute; color: #FFD700; font-size: 24px; animation: starPop 0.8s ease-out forwards; pointer-events: none; z-index: 10; }
        @keyframes starPop {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="toast" id="toast">ÊèêÁ§∫‰ø°ÊÅØ</div>

    <div class="container">
        <div class="header">
            <h1 class="title">‚ú® Âø´‰πêÂ≠¶ÊãºÈü≥ ‚ú®</h1>
            <div class="mode-switch-container">
                <button class="mode-btn active" data-mode="random">üé≤ Ê£ÄÈ™åÊ®°Âºè</button>
                <button class="mode-btn" data-mode="sequential">üìö Â≠¶‰π†Ê®°Âºè</button>
            </div>
        </div>

        <div class="main-display">
            <div class="pinyin-card" id="pinyinCard">
                <div class="queue-badge" id="queueBadge">Ââ© 23 ‰∏™</div>
                <div class="pinyin-text" id="pinyinText">b</div>
                
                <div class="examples-container" id="examplesContainer"></div>
            </div>
        </div>

        <div class="control-panel">
            <div class="category-tabs">
                <button class="tab active" data-category="all">ÂÖ®ÈÉ®</button>
                <button class="tab" data-category="initials">Â£∞ÊØç</button>
                <button class="tab" data-category="finals">ÈüµÊØç</button>
                <button class="tab" data-category="whole">Êï¥‰Ωì</button>
            </div>

            <div class="action-bar">
                <button class="mastery-toggle-btn" id="masteryBtn" title="Ê†áËÆ∞‰∏∫Â∑≤ÊéåÊè°">‚òÖ</button>
                <button class="next-btn" id="nextBtn">
                    <span id="nextBtnText">ÈöèÊú∫Êç¢</span>
                    <span>üëâ</span>
                </button>
            </div>
        </div>

        <div class="stats-panel">
            <div class="stats-header">
                <span id="statsLabel">üèÜ ÂÖ®Â±ÄÊéåÊè°ËøõÂ∫¶</span>
                <span id="statsPercentage">0%</span>
            </div>
            <div class="progress-container">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="text-align: center; margin-top: 4px; font-size: 12px; color: #999;" id="statsText">
                Â∑≤ÊéåÊè° 0 / 0 ‰∏™
            </div>
            <div class="reset-btn-container">
                <!-- ÁßªÈô§‰∫Ü type=button Èò≤Ê≠¢ÈÉ®ÂàÜÂÆâÂçìÊµèËßàÂô®ÂºÇÂ∏∏ÔºåËôΩÁÑ∂Ê†áÂáÜÊé®ËçêÁî® -->
                <button class="reset-link" id="resetBtn">üóëÔ∏è Ê∏ÖÁ©∫ÊéåÊè°ËÆ∞ÂΩï</button>
            </div>
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <div class="confirm-title" id="confirmTitle">Á°ÆËÆ§Êìç‰Ωú</div>
            <div class="confirm-desc" id="confirmDesc">ÂÜÖÂÆπÊèèËø∞</div>
            <div class="confirm-btns">
                <button class="c-btn c-btn-cancel" id="confirmCancel">ÂèñÊ∂à</button>
                <button class="c-btn c-btn-confirm" id="confirmOk">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>

    <script>
        const initials = ['b','p','m','f','d','t','n','l','g','k','h','j','q','x','zh','ch','sh','r','z','c','s','y','w'];
        const finals = ['a','o','e','i','u','√º','ai','ei','ui','ao','ou','iu','ie','√ºe','er','an','en','in','un','√ºn','ang','eng','ing','ong'];
        const wholeSyllables = ['zhi','chi','shi','ri','zi','ci','si','yi','wu','yu','ye','yue','yuan','yin','yun','ying'];

        const pinyinToChars = {
            'b': ['Áà∏(b√†)', 'Ê≥¢(b≈ç)', '‰∏ç(b√π)'], 'p': ['Âù°(p≈ç)', 'ÊÄï(p√†)', 'Êãç(pƒÅi)'],
            'm': ['Â¶à(mƒÅ)', 'Êë∏(m≈ç)', 'Á±≥(m«ê)'], 'f': ['Âèë(fƒÅ)', '‰Ωõ(f√≥)', 'È£û(fƒìi)'],
            'd': ['Â§ß(d√†)', 'ÁöÑ(de)', 'Âú∞(d√¨)'], 't': ['‰ªñ(tƒÅ)', 'Â§©(tiƒÅn)', 'Âúü(t«î)'],
            'n': ['ÈÇ£(n√†)', '‰Ω†(n«ê)', 'Â•≥(n«ö)'], 'l': ['Êãâ(lƒÅ)', '‰∫Ü(le)', 'Èáå(l«ê)'],
            'g': ['Âì•(gƒì)', '‰∏™(g√®)', 'Áãó(g«íu)'], 'k': ['ÂèØ(kƒõ)', 'Âè£(k«íu)', 'ÂºÄ(kƒÅi)'],
            'h': ['Â•Ω(h«éo)', 'Âíå(h√©)', 'Ëä±(huƒÅ)'], 'j': ['ÂÆ∂(jiƒÅ)', 'Âè´(ji√†o)', '‰πù(ji«î)'],
            'q': ['‰∏É(qƒ´)', 'Âéª(q√π)', 'Ââç(qi√°n)'], 'x': ['‰∏ã(xi√†)', 'Â∞è(xi«éo)', 'ÂøÉ(xƒ´n)'],
            'zh': ['‰∏≠(zh≈çng)', 'Âè™(zh«ê)', 'ÁùÄ(zhe)'], 'ch': ['Âá∫(ch≈´)', 'ÂêÉ(chƒ´)', 'ËΩ¶(chƒì)'],
            'sh': ['‰∏ä(sh√†ng)', 'ÊòØ(sh√¨)', 'Êâã(sh«íu)'], 'r': ['‰∫∫(r√©n)', 'ÁÉ≠(r√®)', 'Êó•(r√¨)'],
            'z': ['Âú®(z√†i)', 'Â≠ê(z«ê)', 'Ëµ∞(z«íu)'], 'c': ['‰ªé(c√≥ng)', 'Ê¨°(c√¨)', 'Ëçâ(c«éo)'],
            's': ['‰∏â(sƒÅn)', 'Âõõ(s√¨)', 'ÈÄÅ(s√≤ng)'], 'y': ['‰∏Ä(yƒ´)', 'Êúâ(y«íu)', 'Êúà(yu√®)'],
            'w': ['Êàë(w«í)', '‰∫î(w«î)', 'Â§ñ(w√†i)'], 'a': ['Âïä(a)', 'Èòø(ƒÅ)', 'ËÖå(ƒÅ)'],
            'o': ['Âì¶(o)', 'Âô¢(≈ç)', 'Ê≥¢(b≈ç)'], 'e': ['ÈπÖ(√©)', 'È•ø(√®)', 'È¢ù(√©)'],
            'i': ['Ë°£(yƒ´)', '‰ª•(y«ê)', '‰∏Ä(yƒ´)'], 'u': ['‰πå(w≈´)', 'Â±ã(w≈´)', '‰∫î(w«î)'],
            '√º': ['È±º(y√∫)', 'Èõ®(y«î)', 'Áéâ(y√π)'], 'ai': ['Áà±(√†i)', 'ÁôΩ(b√°i)', 'Â§™(t√†i)'],
            'ei': ['Èªë(hƒìi)', 'Áªô(gƒõi)', 'Èùû(fƒìi)'], 'ui': ['‰ºö(hu√¨)', 'Ê∞¥(shu«ê)', 'Âõû(hu√≠)'],
            'ao': ['Â•Ω(h«éo)', 'È´ò(gƒÅo)', 'Êó©(z«éo)'], 'ou': ['Âêé(h√≤u)', 'Êâã(sh«íu)', 'Âè£(k«íu)'],
            'iu': ['Êúâ(y«íu)', 'ÂÖ≠(li√π)', 'Áâõ(ni√∫)'], 'ie': ['‰πü(yƒõ)', 'Âßê(jiƒõ)', 'ËäÇ(ji√©)'],
            '√ºe': ['Êúà(yu√®)', 'Â≠¶(xu√©)', 'Èõ™(xuƒõ)'], 'er': ['ÂÑø(√©r)', '‰∫å(√®r)', 'ËÄ≥(ƒõr)'],
            'an': ['Â§©(tiƒÅn)', 'Âçä(b√†n)', 'Áúã(k√†n)'], 'en': ['Âæà(hƒõn)', 'Èó®(m√©n)', '‰∫∫(r√©n)'],
            'in': ['ÂøÉ(xƒ´n)', 'Èü≥(yƒ´n)', '‰ªä(jƒ´n)'], 'un': ['Êò•(ch≈´n)', 'Êùë(c≈´n)', 'Â≠ô(s≈´n)'],
            '√ºn': ['‰∫ë(y√∫n)', 'Ëøê(y√πn)', 'Ë£ô(q√∫n)'], 'ang': ['Â∏Æ(bƒÅng)', 'ÂÖâ(guƒÅng)', 'Êñπ(fƒÅng)'],
            'eng': ['ÁÅØ(dƒìng)', 'È£é(fƒìng)', 'ÂÜ∑(lƒõng)'], 'ing': ['Âê¨(tƒ´ng)', 'Êòé(m√≠ng)', 'Êòü(xƒ´ng)'],
            'ong': ['‰∏≠(zh≈çng)', 'Èæô(l√≥ng)', 'Á∫¢(h√≥ng)'], 
            'zhi': ['Âè™(zh«ê)', 'Áü•(zhƒ´)', 'Áõ¥(zh√≠)'], 'chi': ['ÂêÉ(chƒ´)', 'Ëøü(ch√≠)', 'Â∞∫(ch«ê)'], 
            'shi': ['ÊòØ(sh√¨)', 'ÂçÅ(sh√≠)', 'ÁãÆ(shƒ´)'], 'ri': ['Êó•(r√¨)', 'ÁîüÊó•(r√¨)', 'Êó•ÂéÜ(r√¨)'], 
            'zi': ['Â≠ê(z«ê)', 'Â≠ó(z√¨)', 'Á¥´(z«ê)'], 'ci': ['Ê¨°(c√¨)', 'ËØç(c√≠)', 'Áì∑(c√≠)'], 
            'si': ['Âõõ(s√¨)', '‰∏ù(sƒ´)', '‰ºº(s√¨)'], 'yi': ['‰∏Ä(yƒ´)', 'Ë°£(yƒ´)', 'Âåª(yƒ´)'], 
            'wu': ['Êó†(w√∫)', '‰∫î(w«î)', 'Â±ã(w≈´)'], 'yu': ['È±º(y√∫)', 'Áéâ(y√π)', 'Èõ®(y«î)'], 
            'ye': ['‰πü(yƒõ)', 'Â§ú(y√®)', 'Âè∂(y√®)'], 'yue': ['Êúà(yu√®)', 'Ë∂ä(yu√®)', '‰πê(yu√®)'], 
            'yuan': ['ÂúÜ(yu√°n)', 'ÂÖÉ(yu√°n)', 'Ëøú(yu«én)'], 'yin': ['Èü≥(yƒ´n)', 'Èò¥(yƒ´n)', 'Èì∂(y√≠n)'], 
            'yun': ['‰∫ë(y√∫n)', 'Êôï(y≈´n)', 'ÂåÄ(y√∫n)'], 'ying': ['ÂΩ±(y«êng)', 'Á°¨(y√¨ng)', 'Èπ∞(yƒ´ng)']
        };

        class PinyinApp {
            constructor() {
                this.currentCategory = 'all';
                this.currentPinyin = '';
                this.playQueue = []; 
                this.currentListTotal = 0;
                
                this.masteredSet = this.loadData('pinyin_mastered_v1', new Set());
                this.seqProgress = this.loadData('pinyin_seq_progress', {}); 

                this.totalPinyinCount = initials.length + finals.length + wholeSyllables.length;
                this.mode = 'random'; 
                
                this.initElements();
                this.bindEvents();
                
                this.switchMode('random');
                this.switchCategory('all', false);
            }

            initElements() {
                this.pinyinCard = document.getElementById('pinyinCard');
                this.pinyinText = document.getElementById('pinyinText');
                this.examplesContainer = document.getElementById('examplesContainer');
                this.masteryBtn = document.getElementById('masteryBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.nextBtnText = document.getElementById('nextBtnText');
                this.resetBtn = document.getElementById('resetBtn');
                this.statsLabel = document.getElementById('statsLabel');
                this.statsText = document.getElementById('statsText');
                this.statsPercentage = document.getElementById('statsPercentage');
                this.progressFill = document.getElementById('progressFill');
                this.tabs = document.querySelectorAll('.tab');
                this.queueBadge = document.getElementById('queueBadge');
                this.toast = document.getElementById('toast');
                this.modeBtns = document.querySelectorAll('.mode-btn');
                
                // Confirm Modal Elements
                this.confirmModal = document.getElementById('confirmModal');
                this.confirmTitle = document.getElementById('confirmTitle');
                this.confirmDesc = document.getElementById('confirmDesc');
                this.confirmCancel = document.getElementById('confirmCancel');
                this.confirmOk = document.getElementById('confirmOk');
            }

            bindEvents() {
                this.pinyinCard.addEventListener('click', () => this.nextPinyin());
                this.nextBtn.addEventListener('click', (e) => {
                    e.currentTarget.blur();
                    this.nextPinyin();
                });
                this.masteryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleMastery();
                });
                
                // ÈáçÁΩÆÊåâÈíÆÁÇπÂáª - ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
                this.resetBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showConfirm();
                });

                // Ê®°ÊÄÅÊ°ÜÊåâÈíÆ
                this.confirmCancel.addEventListener('click', () => this.hideConfirm());
                this.confirmOk.addEventListener('click', () => {
                    this.performReset();
                    this.hideConfirm();
                });
                
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', () => this.switchCategory(tab.dataset.category));
                });

                this.modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.switchMode(btn.dataset.mode));
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === ' ' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        this.nextPinyin();
                    }
                });
            }

            switchMode(newMode) {
                if (this.mode === newMode && this.currentPinyin) return;
                this.mode = newMode;
                
                this.modeBtns.forEach(btn => {
                    if (btn.dataset.mode === newMode) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                
                if (newMode === 'sequential') {
                    this.nextBtn.classList.add('sequential-mode');
                    this.progressFill.classList.add('sequential');
                    this.nextBtnText.textContent = '‰∏ã‰∏Ä‰∏™';
                    this.resetBtn.textContent = 'üîÑ ‰ªéÂ§¥ÂºÄÂßãÂ≠¶‰π†';
                    this.resetBtn.style.background = '#42e695';
                } else {
                    this.nextBtn.classList.remove('sequential-mode');
                    this.progressFill.classList.remove('sequential');
                    this.nextBtnText.textContent = 'ÈöèÊú∫Êç¢';
                    this.resetBtn.textContent = 'üóëÔ∏è Ê∏ÖÁ©∫ÊéåÊè°ËÆ∞ÂΩï';
                    this.resetBtn.style.background = '#ff7675';
                }

                this.generateQueue(this.currentCategory);
                this.nextPinyin();
            }

            switchCategory(category, refresh = true) {
                if (this.currentCategory === category && this.currentPinyin) return;
                this.currentCategory = category;
                
                this.tabs.forEach(tab => {
                    if (tab.dataset.category === category) tab.classList.add('active');
                    else tab.classList.remove('active');
                });
                
                if (refresh) {
                    this.generateQueue(category);
                    this.nextPinyin();
                }
            }

            generateQueue(category) {
                let list;
                switch(category) {
                    case 'initials': list = [...initials]; break;
                    case 'finals': list = [...finals]; break;
                    case 'whole': list = [...wholeSyllables]; break;
                    default: list = [...initials, ...finals, ...wholeSyllables];
                }
                
                this.currentListTotal = list.length;

                if (this.mode === 'sequential') {
                    const savedIndex = this.seqProgress[category] || 0;
                    if (savedIndex >= list.length) {
                         this.playQueue = [];
                    } else {
                        this.playQueue = list.slice(savedIndex).reverse();
                    }
                } else {
                    for (let i = list.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [list[i], list[j]] = [list[j], list[i]];
                    }
                    this.playQueue = list;
                }
            }

            nextPinyin() {
                if (this.playQueue.length === 0) {
                    if (this.mode === 'sequential') {
                        this.showToast("üéâ Êú¨ÁªÑÂ≠¶‰π†ÂÆåÊàêÔºÅ<br>Ëá™Âä®‰ªéÂ§¥ÂºÄÂßã");
                        this.seqProgress[this.currentCategory] = 0;
                        this.saveSeqProgress();
                        this.generateQueue(this.currentCategory);
                    } else {
                        this.showToast("‚ú® Êú¨ËΩÆÂ§ç‰π†ÂÆåÊàêÔºÅ<br>ÈáçÊñ∞Ê¥óÁâå");
                        this.generateQueue(this.currentCategory);
                    }
                }

                this.currentPinyin = this.playQueue.pop();
                
                if (this.mode === 'sequential') {
                    const currentIndex = this.currentListTotal - this.playQueue.length;
                    this.seqProgress[this.currentCategory] = currentIndex;
                    this.saveSeqProgress();
                }

                this.pinyinText.classList.remove('rotating');
                void this.pinyinText.offsetWidth; 
                this.updateDisplay();
                this.updateStats();
            }

            updateDisplay() {
                this.pinyinText.textContent = this.currentPinyin;
                
                if (this.mode === 'sequential') {
                     this.queueBadge.textContent = `Ââ©‰Ωô ${this.playQueue.length} ‰∏™`;
                } else {
                     this.queueBadge.textContent = `Êú¨ËΩÆÂâ© ${this.playQueue.length} ‰∏™`;
                }
                
                const chars = pinyinToChars[this.currentPinyin] || ['Êó†Êï∞ÊçÆ'];
                this.examplesContainer.innerHTML = chars.slice(0, 3).map(char => {
                    const match = char.match(/(.+)\((.+)\)/);
                    if (match) return `<div class="example-item"><span class="example-char">${match[1]}</span><span class="example-pinyin">${match[2]}</span></div>`;
                    return `<div class="example-item"><span class="example-char">${char}</span></div>`;
                }).join('');

                const isMastered = this.masteredSet.has(this.currentPinyin);
                if (isMastered) {
                    this.masteryBtn.classList.add('active');
                    this.pinyinCard.classList.add('mastered');
                    this.masteryBtn.textContent = '‚òÖ'; 
                } else {
                    this.masteryBtn.classList.remove('active');
                    this.pinyinCard.classList.remove('mastered');
                    this.masteryBtn.textContent = '‚òÜ'; 
                }
            }

            updateStats() {
                if (this.mode === 'sequential') {
                    const currentIndex = this.seqProgress[this.currentCategory] || 0;
                    const displayIndex = Math.min(currentIndex, this.currentListTotal);
                    const progress = this.currentListTotal === 0 ? 0 : (displayIndex / this.currentListTotal) * 100;
                    
                    this.statsLabel.textContent = "üìö ÂΩìÂâçÂàÜÁ±ªËøõÂ∫¶";
                    this.progressFill.style.width = `${progress}%`;
                    this.statsText.textContent = `Â∑≤Â≠¶ ${displayIndex} / ${this.currentListTotal}`;
                    this.statsPercentage.textContent = Math.round(progress) + '%';
                } else {
                    const count = this.masteredSet.size;
                    const progress = (count / this.totalPinyinCount) * 100;
                    
                    this.statsLabel.textContent = "üèÜ ÂÖ®Â±ÄÊéåÊè°ËøõÂ∫¶";
                    this.progressFill.style.width = `${Math.min(progress, 100)}%`;
                    this.statsText.textContent = `ÂÖ±ÊéåÊè° ${count} / ${this.totalPinyinCount}`;
                    this.statsPercentage.textContent = Math.round(progress) + '%';
                }
            }

            toggleMastery() {
                if (this.masteredSet.has(this.currentPinyin)) {
                    this.masteredSet.delete(this.currentPinyin);
                } else {
                    this.masteredSet.add(this.currentPinyin);
                    this.createStars(); 
                }
                this.saveMasteredData();
                this.updateDisplay();
                if (this.mode === 'random') {
                    this.updateStats();
                }
            }

            // --- Á°ÆËÆ§ÂºπÁ™óÈÄªËæë ---
            showConfirm() {
                if (this.mode === 'sequential') {
                    this.confirmTitle.textContent = "ÈáçÊñ∞Â≠¶‰π†";
                    this.confirmDesc.textContent = "Á°ÆÂÆöË¶Å‰ªéÁ¨¨‰∏Ä‰∏™ÊãºÈü≥ÂºÄÂßãÈáçÊñ∞Â≠¶‰π†ÂΩìÂâçÂàÜÁ±ªÂêóÔºü";
                } else {
                    this.confirmTitle.textContent = "Ê∏ÖÁ©∫ËÆ∞ÂΩï";
                    this.confirmDesc.textContent = "Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ∑≤ÊéåÊè°ÁöÑÊòüÊòüËÆ∞ÂΩïÂêóÔºü";
                }
                this.confirmModal.style.display = 'flex';
                setTimeout(() => this.confirmModal.classList.add('show'), 10);
            }

            hideConfirm() {
                this.confirmModal.classList.remove('show');
                setTimeout(() => this.confirmModal.style.display = 'none', 200);
            }

            performReset() {
                if (this.mode === 'sequential') {
                    // ÈáçÁΩÆÈÄªËæëÔºöÂ∞ÜÂΩìÂâçÂàÜÁ±ªÁöÑÂ≠òÂÇ®ËøõÂ∫¶ÁΩÆ0
                    this.seqProgress[this.currentCategory] = 0;
                    this.saveSeqProgress();
                    // ÈáçÊñ∞ÁîüÊàêÈòüÂàóÂπ∂Â±ïÁ§∫
                    this.generateQueue(this.currentCategory);
                    this.nextPinyin();
                    this.showToast('üìö Â∑≤ÈáçÁΩÆËøõÂ∫¶Ôºå‰ªéÂ§¥ÂºÄÂßã');
                } else {
                    this.masteredSet.clear();
                    this.saveMasteredData();
                    this.updateDisplay();
                    this.updateStats();
                    this.showToast('üóëÔ∏è Â∑≤Ê∏ÖÁ©∫ÊéåÊè°ËÆ∞ÂΩï');
                }
            }

            showToast(msg) {
                this.toast.innerHTML = msg;
                this.toast.classList.add('show');
                setTimeout(() => {
                    this.toast.classList.remove('show');
                }, 2000);
            }

            createStars() {
                const colors = ['#FFD700', '#FF9A9E', '#A18CD1', '#84FAB0'];
                for (let i = 0; i < 8; i++) {
                    const star = document.createElement('div');
                    star.className = 'star-anim';
                    star.textContent = '‚òÖ';
                    star.style.left = (20 + Math.random() * 60) + '%';
                    star.style.top = (20 + Math.random() * 60) + '%';
                    star.style.color = colors[Math.floor(Math.random() * colors.length)];
                    star.style.fontSize = (20 + Math.random() * 20) + 'px';
                    this.pinyinCard.appendChild(star);
                    setTimeout(() => star.remove(), 800);
                }
            }

            loadData(key, defaultVal) {
                try {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (defaultVal instanceof Set) return new Set(parsed);
                        return parsed;
                    }
                } catch (e) { }
                return defaultVal;
            }

            saveMasteredData() {
                localStorage.setItem('pinyin_mastered_v1', JSON.stringify(Array.from(this.masteredSet)));
            }

            saveSeqProgress() {
                localStorage.setItem('pinyin_seq_progress', JSON.stringify(this.seqProgress));
            }
        }

        const app = new PinyinApp();
    </script>
</body>
</html>
